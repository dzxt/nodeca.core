#!/usr/bin/env node

'use strict';

/*global nodeca*/


var Async = require('async');

require('nlib').Application.create({
  name: 'nodeca',
  root: process.cwd()
}).run(['init-start', 'models-tree', 'shared-tree'], function(err){
  if (err){
    console.log(err);
    process.exit(0);
  }
  var current = nodeca.models.Migrations.first(); // get current migrations

  var migrations = nodeca.runtime.migration_tool.getMigrationsStatus(current);

  Async.forEachSeries(migrations, function(migration, next_migration){
    nodeca.runtime.migration_tool.runMigration(migration, function(err){
      if (err){
        nodeca.models.Migration.migration_fail(migration);
        next_migration(err);
        return;
      }
      nodeca.models.Migration.migration_success(migration);
      next_migration();
    });
  }, function(err) {
    console.log(err);
  });
  process.exit(0);
});
//}).run();

